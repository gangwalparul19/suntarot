<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View your past tarot readings and insights.">
    <title>My Readings - Sun Tarot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=PT+Sans:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/my-readings.css">
</head>

<body>
    <div class="stars" id="stars"></div>

    <header class="header">
        <nav class="nav container">
            <a href="index.html" class="logo">
                <img src="images/logo.png" alt="Sun Tarot" class="logo-img">
                <span>Sun Tarot</span>
            </a>

            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="reading.html">Reading</a></li>
                <li><a href="love-reading.html">Love</a></li>
                <li><a href="learn.html">Learn</a></li>
                <li><a href="quiz.html">Quiz</a></li>
                <li><a href="spreads.html">Spreads</a></li>
                <li><a href="faq.html">FAQ</a></li>
                <li><a href="booking.html">Book Your Reading</a></li>
            </ul>

            <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">‚ò∞</button>
            <div class="auth-container" id="authContainer" style="display: flex; align-items: center; gap: 1rem;">
                <div id="userInfo" style="display: none; align-items: center; gap: 0.5rem;"></div>
                <button class="btn btn-outline" id="loginBtn" onclick="signInWithGoogle()"
                    style="padding: 0.5rem 1rem; font-size: 0.875rem;">Sign In</button>
                <button class="btn btn-outline" id="logoutBtn" onclick="signOut()"
                    style="display: none; padding: 0.5rem 1rem; font-size: 0.875rem;">Sign Out</button>
                <a href="admin.html" id="adminLink"
                    style="display: none; color: var(--color-primary); font-size: 0.875rem;">Admin</a>
            </div>
        </nav>
    </header>

    <main class="section" style="padding-top: 120px;">
        <div class="container readings-container">
            <div class="section-header">
                <h1 class="section-title text-primary">My Reading History</h1>
                <p class="section-subtitle">Revisit your past readings and insights</p>
            </div>

            <!-- Login Required -->
            <div class="empty-state" id="loginPrompt">
                <h3 style="color: var(--color-primary);">Sign In Required</h3>
                <p class="text-muted" style="margin-bottom: 1.5rem;">Sign in to save and view your reading history.</p>
                <button class="btn btn-primary" onclick="signInWithGoogle()">üîê Sign In with Google</button>
            </div>

            <!-- Readings Content -->
            <div id="readingsContent" style="display: none;">

                <!-- Statistics -->
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">Total Readings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statMostCard">-</div>
                        <div class="stat-label">Most Drawn</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statStreak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statLastReading">-</div>
                        <div class="stat-label">Last Reading</div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterReadings('all')">All</button>
                    <button class="filter-tab" onclick="filterReadings('reading')">üîÆ Regular</button>
                    <button class="filter-tab" onclick="filterReadings('love')">üíï Love</button>
                </div>

                <!-- Search -->
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search by card name..."
                        oninput="searchReadings(this.value)">
                </div>

                <!-- Readings List -->
                <div id="readingsList">
                    <p class="text-muted text-center">Loading your readings...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer footer-single-row">
        <div class="container">
            <div class="footer-bottom">
                <p>Designed with ‚ù§Ô∏è by Parul Gangwal</p>
            </div>
        </div>
    </footer>

    <button class="scroll-top" id="scrollTop">‚Üë</button>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Environment Config -->
    <script src="js/env.js" onerror="console.log('env.js not found')"></script>

    <!-- Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/share.js"></script>
    <script src="js/main.js"></script>

    <script>
        let allReadings = [];
        let currentFilter = 'all';
        let searchQuery = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updateUIState, 500);
        });

        function updateUIState() {
            const loginPrompt = document.getElementById('loginPrompt');
            const readingsContent = document.getElementById('readingsContent');

            if (isLoggedIn()) {
                loginPrompt.style.display = 'none';
                readingsContent.style.display = 'block';
                loadReadings();
            } else {
                loginPrompt.style.display = 'block';
                readingsContent.style.display = 'none';
            }
        }

        async function loadReadings() {
            allReadings = await getReadingHistory(100);
            updateStats();
            renderReadings(getFilteredReadings());
        }

        function getFilteredReadings() {
            let filtered = allReadings;

            // Apply type filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(r => r.spreadType === currentFilter);
            }

            // Apply search filter
            if (searchQuery.trim()) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(r =>
                    r.cards.some(c => c.name.toLowerCase().includes(query))
                );
            }

            return filtered;
        }

        function filterReadings(type) {
            currentFilter = type;

            // Update tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            renderReadings(getFilteredReadings());
        }

        function searchReadings(query) {
            searchQuery = query;
            renderReadings(getFilteredReadings());
        }

        function updateStats() {
            // Total readings
            document.getElementById('statTotal').textContent = allReadings.length;

            // Most drawn card
            const cardCounts = {};
            allReadings.forEach(r => {
                r.cards.forEach(c => {
                    cardCounts[c.name] = (cardCounts[c.name] || 0) + 1;
                });
            });
            const mostDrawn = Object.entries(cardCounts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('statMostCard').textContent = mostDrawn
                ? mostDrawn[0].split(' ').pop() // Get last word (e.g., "Fool" from "The Fool")
                : '-';

            // Calculate streak
            const streak = calculateStreak();
            document.getElementById('statStreak').textContent = streak;

            // Last reading
            if (allReadings.length > 0) {
                const lastReading = allReadings[0];
                const date = lastReading.createdAt?.toDate ? lastReading.createdAt.toDate() : new Date(lastReading.createdAt);
                const daysAgo = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
                document.getElementById('statLastReading').textContent = daysAgo === 0 ? 'Today' : `${daysAgo}d ago`;
            }
        }

        function calculateStreak() {
            if (allReadings.length === 0) return 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Get unique dates
            const dates = [...new Set(allReadings.map(r => {
                const date = r.createdAt?.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
                date.setHours(0, 0, 0, 0);
                return date.getTime();
            }))].sort((a, b) => b - a);

            let streak = 0;
            let checkDate = today.getTime();

            for (const dateTime of dates) {
                if (dateTime === checkDate) {
                    streak++;
                    checkDate -= 24 * 60 * 60 * 1000; // Go back one day
                } else if (dateTime < checkDate) {
                    // Missed a day, but check if first reading is today
                    if (streak === 0 && dateTime === today.getTime() - 24 * 60 * 60 * 1000) {
                        streak = 1;
                        checkDate = dateTime - 24 * 60 * 60 * 1000;
                    } else {
                        break;
                    }
                }
            }

            return streak;
        }

        function renderReadings(readings) {
            const container = document.getElementById('readingsList');

            if (readings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3 style="color: var(--color-primary);">${searchQuery ? 'No Matching Readings' : 'No Readings Yet'}</h3>
                        <p class="text-muted" style="margin-bottom: 1.5rem;">
                            ${searchQuery ? 'Try a different search term.' : 'Start a reading to save it to your history!'}
                        </p>
                        ${!searchQuery ? '<a href="reading.html" class="btn btn-primary">üîÆ Get a Reading</a>' : ''}
                    </div>
                `;
                return;
            }

            // Group by date for timeline
            let lastDateStr = '';

            container.innerHTML = readings.map(reading => {
                const date = reading.createdAt?.toDate ? reading.createdAt.toDate() : new Date(reading.createdAt);
                const dateStr = date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });

                let timelineHtml = '';
                if (dateStr !== lastDateStr) {
                    lastDateStr = dateStr;
                    timelineHtml = `
                        <div class="timeline-indicator">
                            <div class="timeline-dot"></div>
                            <span class="timeline-date">${dateStr}</span>
                        </div>
                    `;
                }

                return `
                    ${timelineHtml}
                    <div class="reading-card">
                        <button class="delete-btn" onclick="deleteReadingItem('${reading.id}')" title="Delete reading">üóëÔ∏è</button>
                        <div class="reading-header">
                            <span class="reading-type ${reading.spreadType === 'love' ? 'love' : ''}">
                                ${getSpreadLabel(reading.spreadType)}
                            </span>
                            <span class="reading-date">${formatReadingTime(reading.createdAt)}</span>
                        </div>
                        <div class="reading-cards">
                            ${reading.cards.map(card => `
                                <div class="card-mini ${card.isReversed ? 'reversed' : ''}" title="${card.name}${card.isReversed ? ' (Reversed)' : ''}">
                                    ${card.image ? `<img src="${card.image}" alt="${card.name}">` : `<div style="display:flex;align-items:center;justify-content:center;height:100%;background:var(--color-card);">üÉè</div>`}
                                    ${card.isReversed ? '<span class="reversed-indicator">R</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="card-names">
                            <strong>Cards:</strong> ${reading.cards.map(c => c.name + (c.isReversed ? ' ‚Ü∫' : '')).join(' ‚Ä¢ ')}
                        </div>
                        <div class="reading-actions">
                            <button class="btn btn-outline" onclick='shareReading(${JSON.stringify(reading.cards).replace(/'/g, "\\'")},"${reading.spreadType}")' 
                                    style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                üì§ Share
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteReadingItem(readingId) {
            if (!confirm('Delete this reading from your history?')) return;

            try {
                if (typeof db !== 'undefined' && db) {
                    await db.collection('readings').doc(readingId).delete();
                    toastSuccess('Reading deleted');
                    loadReadings();
                }
            } catch (error) {
                console.error('Error deleting reading:', error);
                toastError('Failed to delete reading');
            }
        }

        function getSpreadLabel(type) {
            const labels = {
                'reading': 'üîÆ Past ‚Ä¢ Present ‚Ä¢ Future',
                'love': 'üíï Love Reading',
                'daily': '‚òÄÔ∏è Daily Card'
            };
            return labels[type] || 'üîÆ Reading';
        }

        function formatReadingTime(timestamp) {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Update UI on auth change
        const originalUpdateAuthUI = window.updateAuthUI;
        window.updateAuthUI = function (user) {
            if (originalUpdateAuthUI) originalUpdateAuthUI(user);
            updateUIState();
        };
    </script>
</body>

</html>