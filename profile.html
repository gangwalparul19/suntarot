<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Sun Tarot</title>
    <meta name="description" content="Your Sun Tarot profile, reading stats, and achievements.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=PT+Sans:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <!-- Styles moved to css/style.css -->
</head>

<body>
    <div class="stars" id="stars"></div>

    <header class="header">
        <nav class="nav container">
            <a href="index.html" class="logo"><span>‚òÄÔ∏è</span><span>Sun Tarot</span></a>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="reading.html">Reading</a></li>
                <li><a href="love-reading.html">Love</a></li>
                <li><a href="learn.html">Learn</a></li>
                <li><a href="quiz.html">Quiz</a></li>
                <li><a href="booking.html">Book</a></li>
            </ul>
            <div class="auth-container" id="authContainer">
                <div id="userInfo"></div>
                <button class="btn btn-outline" id="loginBtn" onclick="signInWithGoogle()"
                    style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                    Sign In
                </button>
                <button class="btn btn-outline" id="logoutBtn" onclick="signOut()"
                    style="display: none; padding: 0.5rem 1rem; font-size: 0.875rem;">
                    Sign Out
                </button>
            </div>
            <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
        </nav>
    </header>

    <main class="section" style="padding-top: 120px;">
        <div class="container">
            <!-- Login Required -->
            <div class="login-prompt" id="loginPrompt">
                <h2>Sign In to View Your Profile</h2>
                <p class="text-muted mb-md">Track your reading journey, streaks, and achievements.</p>
                <button class="btn btn-primary" onclick="signInWithGoogle()">Sign In with Google</button>
            </div>

            <!-- Profile Content -->
            <div id="profileContent" style="display: none;">
                <!-- Profile Header -->
                <div class="profile-header">
                    <img id="profileAvatar" class="profile-avatar" src="" alt="Profile">
                    <h1 id="profileName" class="profile-name"></h1>
                    <p id="profileEmail" class="profile-email"></p>
                    <div class="profile-details-form" style="max-width: 300px; margin: 1rem auto;">
                        <div style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem;">
                            <input type="tel" id="userMobile" class="form-control" placeholder="Mobile Number"
                                style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--color-border); background: var(--color-background); color: var(--color-text); width: 100%;">
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <input type="text" id="userCity" class="form-control" placeholder="City"
                                style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--color-border); background: var(--color-background); color: var(--color-text); width: 100%;">
                        </div>
                        <button onclick="saveProfileDetails()" class="btn btn-primary"
                            style="padding: 0.5rem 1rem; width: 100%; font-size: 0.875rem;">Save Details</button>
                    </div>
                </div>

                <!-- Streak Section -->
                <div class="streak-section">
                    <div class="streak-flame" style="font-size: 5rem; line-height: 1;">‚òÄÔ∏è</div>
                    <div class="streak-count" id="streakCount">0</div>
                    <div class="streak-label">Day Reading Streak</div>
                    <p class="text-muted" id="streakMessage">Start your streak today!</p>
                    <div class="streak-calendar" id="streakCalendar"></div>
                </div>

                <!-- Stats Grid -->
                <h2 class="section-subtitle text-primary mb-md">üìä Your Stats</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-icon">üé¥</div>
                        <div class="stat-value" id="totalReadings">0</div>
                        <div class="stat-label">Total Readings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíï</div>
                        <div class="stat-value" id="loveReadings">0</div>
                        <div class="stat-label">Love Readings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-value" id="daysActive">0</div>
                        <div class="stat-label">Days Active</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-value" id="reversedCards">0%</div>
                        <div class="stat-label">Reversed Cards</div>
                    </div>
                </div>

                <!-- Favorite Cards -->
                <h2 class="section-subtitle text-primary mb-md">‚≠ê Most Drawn Cards</h2>
                <div class="favorite-cards">
                    <div class="favorite-cards-grid" id="favoriteCards">
                        <p class="text-muted">Do more readings to see your patterns!</p>
                    </div>
                </div>

                <!-- Achievements -->
                <h2 class="section-subtitle text-primary mb-md">üèÜ Achievements</h2>
                <div class="achievements-grid" id="achievements"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>Designed with ‚ù§Ô∏è by Parul Gangwal</p>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Environment Config (generated by build) -->
    <script src="js/env.js" onerror="console.log('env.js not found - using placeholder config')"></script>

    <!-- App Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cards.js"></script>
    <script src="js/main.js"></script>

    <script>
        // Achievement definitions
        const ACHIEVEMENTS = [
            { id: 'first_reading', icon: 'üé¥', name: 'First Steps', desc: 'Complete your first reading', check: (s) => s.totalReadings >= 1 },
            { id: '10_readings', icon: 'üåü', name: 'Seeker', desc: 'Complete 10 readings', check: (s) => s.totalReadings >= 10 },
            { id: '50_readings', icon: '‚ú®', name: 'Devoted', desc: 'Complete 50 readings', check: (s) => s.totalReadings >= 50 },
            { id: '100_readings', icon: 'üîÆ', name: 'Oracle', desc: 'Complete 100 readings', check: (s) => s.totalReadings >= 100 },
            { id: '3_streak', icon: 'üî•', name: 'On Fire', desc: '3-day reading streak', check: (s) => s.maxStreak >= 3 },
            { id: '7_streak', icon: 'üí´', name: 'Dedicated', desc: '7-day reading streak', check: (s) => s.maxStreak >= 7 },
            { id: '30_streak', icon: 'üåô', name: 'Lunar Cycle', desc: '30-day reading streak', check: (s) => s.maxStreak >= 30 },
            { id: 'love_reader', icon: 'üíï', name: 'Romantic', desc: 'Complete 5 love readings', check: (s) => s.loveReadings >= 5 },
            { id: 'all_major', icon: 'üéØ', name: 'Collector', desc: 'Draw all 22 Major Arcana', check: (s) => s.uniqueCards >= 22 },
            { id: 'night_owl', icon: 'ü¶â', name: 'Night Owl', desc: 'Read after midnight', check: (s) => s.hasNightReading },
            { id: 'early_bird', icon: 'üåÖ', name: 'Early Bird', desc: 'Read before 6am', check: (s) => s.hasEarlyReading },
            { id: 'reversed_master', icon: 'üîÑ', name: 'Reversal Master', desc: 'Get 10 reversed cards', check: (s) => s.reversedCount >= 10 }
        ];

        // Load profile data
        async function loadProfile() {
            const loginPrompt = document.getElementById('loginPrompt');
            const profileContent = document.getElementById('profileContent');

            if (!isLoggedIn()) {
                loginPrompt.style.display = 'block';
                profileContent.style.display = 'none';
                return;
            }

            loginPrompt.style.display = 'none';
            profileContent.style.display = 'block';

            const user = auth.currentUser;

            // Set profile info
            document.getElementById('profileAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}`;
            document.getElementById('profileName').textContent = user.displayName || 'Tarot Reader';
            document.getElementById('profileEmail').textContent = user.email;

            // Load extra details (Mobile, City)
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    if (data.mobile) document.getElementById('userMobile').value = data.mobile;
                    if (data.city) document.getElementById('userCity').value = data.city;
                }
            } catch (error) {
                console.error("Error loading user details:", error);
            }

            // Load readings
            const readings = await loadReadings();
            const stats = calculateStats(readings);

            // Update stats
            document.getElementById('totalReadings').textContent = stats.totalReadings;
            document.getElementById('loveReadings').textContent = stats.loveReadings;
            document.getElementById('daysActive').textContent = stats.uniqueDays;
            document.getElementById('reversedCards').textContent = stats.reversedPercent + '%';

            // Update streak
            document.getElementById('streakCount').textContent = stats.currentStreak;
            updateStreakMessage(stats.currentStreak);
            renderStreakCalendar(readings);

            // Render favorite cards
            renderFavoriteCards(stats.cardCounts);

            // Render achievements
            renderAchievements(stats);

            // Render badges
            renderBadges(stats);
        }

        async function loadReadings() {
            try {
                const snapshot = await db.collection('readings')
                    .where('userId', '==', auth.currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                return snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    createdAt: doc.data().createdAt?.toDate()
                }));
            } catch (error) {
                console.error('Error loading readings:', error);
                return [];
            }
        }

        function calculateStats(readings) {
            const stats = {
                totalReadings: readings.length,
                loveReadings: 0,
                uniqueDays: new Set(),
                cardCounts: {},
                reversedCount: 0,
                uniqueCards: new Set(),
                currentStreak: 0,
                maxStreak: 0,
                hasNightReading: false,
                hasEarlyReading: false,
                reversedPercent: 0
            };

            let totalCards = 0;

            readings.forEach(reading => {
                if (reading.type === 'love') stats.loveReadings++;

                if (reading.createdAt) {
                    const dateStr = reading.createdAt.toISOString().split('T')[0];
                    stats.uniqueDays.add(dateStr);

                    const hour = reading.createdAt.getHours();
                    if (hour >= 0 && hour < 6) stats.hasEarlyReading = true;
                    if (hour >= 0 && hour < 5) stats.hasNightReading = true;
                }

                if (reading.cards) {
                    reading.cards.forEach(card => {
                        stats.cardCounts[card.name] = (stats.cardCounts[card.name] || 0) + 1;
                        stats.uniqueCards.add(card.name);
                        totalCards++;
                        if (card.isReversed) stats.reversedCount++;
                    });
                }
            });

            stats.uniqueDays = stats.uniqueDays.size;
            stats.uniqueCards = stats.uniqueCards.size;
            stats.reversedPercent = totalCards > 0 ? Math.round((stats.reversedCount / totalCards) * 100) : 0;

            // Calculate streak
            const today = new Date().toISOString().split('T')[0];
            const readingDates = new Set(readings.map(r => r.createdAt?.toISOString().split('T')[0]).filter(Boolean));

            let streak = 0;
            let date = new Date();
            while (true) {
                const dateStr = date.toISOString().split('T')[0];
                if (readingDates.has(dateStr)) {
                    streak++;
                    date.setDate(date.getDate() - 1);
                } else if (dateStr === today) {
                    // Today hasn't happened yet, check yesterday
                    date.setDate(date.getDate() - 1);
                } else {
                    break;
                }
            }
            stats.currentStreak = streak;

            // Calculate max streak
            const sortedDates = Array.from(readingDates).sort();
            let maxStreak = 0;
            let currentMax = 0;
            let prevDate = null;

            sortedDates.forEach(dateStr => {
                const date = new Date(dateStr);
                if (prevDate) {
                    const diff = (date - prevDate) / (1000 * 60 * 60 * 24);
                    if (diff === 1) {
                        currentMax++;
                    } else {
                        currentMax = 1;
                    }
                } else {
                    currentMax = 1;
                }
                maxStreak = Math.max(maxStreak, currentMax);
                prevDate = date;
            });
            stats.maxStreak = maxStreak;

            return stats;
        }

        function updateStreakMessage(streak) {
            const msg = document.getElementById('streakMessage');
            if (streak === 0) {
                msg.textContent = 'Do a reading today to start your streak!';
            } else if (streak < 3) {
                msg.textContent = 'Keep it going! A few more days to unlock achievements.';
            } else if (streak < 7) {
                msg.textContent = 'Great progress! You\'re building a habit.';
            } else if (streak < 30) {
                msg.textContent = 'Amazing dedication! Keep the flame alive.';
            } else {
                msg.textContent = 'Incredible! You\'re a true oracle.';
            }
        }

        function renderStreakCalendar(readings) {
            const calendar = document.getElementById('streakCalendar');
            const readingDates = new Set(readings.map(r => r.createdAt?.toISOString().split('T')[0]).filter(Boolean));

            let html = '';
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const isActive = readingDates.has(dateStr);
                const isToday = i === 0;

                html += `<div class="streak-day ${isActive ? 'active' : ''} ${isToday ? 'today' : ''}" 
                              title="${date.toLocaleDateString('en-IN', { weekday: 'short', month: 'short', day: 'numeric' })}"></div>`;
            }

            calendar.innerHTML = html;
        }

        function renderFavoriteCards(cardCounts) {
            const container = document.getElementById('favoriteCards');
            const sorted = Object.entries(cardCounts).sort((a, b) => b[1] - a[1]).slice(0, 6);

            if (sorted.length === 0) {
                container.innerHTML = '<p class="text-muted">Do more readings to see your patterns!</p>';
                return;
            }

            container.innerHTML = sorted.map(([name, count]) => {
                const card = majorArcana.find(c => c.name === name);
                return `
                    <div class="favorite-card">
                        <img src="${card?.image || ''}" alt="${name}" loading="lazy">
                        <div class="favorite-card-name">${name}</div>
                        <div class="favorite-card-count">${count} times</div>
                    </div>
                `;
            }).join('');
        }

        function renderAchievements(stats) {
            const container = document.getElementById('achievements');

            container.innerHTML = ACHIEVEMENTS.map(ach => {
                const unlocked = ach.check(stats);
                return `
                    <div class="achievement ${unlocked ? 'unlocked' : ''}">
                        <div class="achievement-icon">${ach.icon}</div>
                        <div class="achievement-name">${ach.name}</div>
                        <div class="achievement-desc">${ach.desc}</div>
                    </div>
                `;
            }).join('');
        }

        function renderBadges(stats) {
            const container = document.getElementById('profileBadges');
            const badges = [];

            if (stats.totalReadings >= 100) badges.push({ icon: 'üîÆ', text: 'Oracle' });
            else if (stats.totalReadings >= 50) badges.push({ icon: '‚ú®', text: 'Devoted' });
            else if (stats.totalReadings >= 10) badges.push({ icon: 'üåü', text: 'Seeker' });

            if (stats.maxStreak >= 30) badges.push({ icon: 'üåô', text: 'Monthly Streak' });
            else if (stats.maxStreak >= 7) badges.push({ icon: 'üí´', text: 'Weekly Streak' });

            if (stats.uniqueCards >= 22) badges.push({ icon: 'üéØ', text: 'Collector' });

            container.innerHTML = badges.map(b =>
                `<span class="profile-badge">${b.icon} ${b.text}</span>`
            ).join('');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadProfile, 500);
        });

        // Update on auth change
        const originalUpdateAuthUI = window.updateAuthUI;
        window.updateAuthUI = function (user) {
            if (originalUpdateAuthUI) originalUpdateAuthUI(user);
            loadProfile();
        };

        // Save Profile Details
        async function saveProfileDetails() {
            if (!auth.currentUser) return;

            const mobile = document.getElementById('userMobile').value;
            const city = document.getElementById('userCity').value;
            const btn = document.querySelector('.profile-details-form button');

            if (!mobile && !city) {
                if (typeof toastError === 'function') toastError('Please enter details to save');
                return;
            }

            try {
                btn.textContent = 'Saving...';
                btn.disabled = true;

                await db.collection('users').doc(auth.currentUser.uid).set({
                    mobile: mobile,
                    city: city,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                if (typeof toastSuccess === 'function') toastSuccess('Profile updated successfully!');
            } catch (error) {
                console.error('Error saving profile:', error);
                if (typeof toastError === 'function') toastError('Error saving profile');
            } finally {
                btn.textContent = 'Save Details';
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>